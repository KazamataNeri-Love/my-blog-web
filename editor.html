<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章编辑器</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; height: 95vh; }
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 15px; }
        input#file-path { flex: 1; padding: 10px; font-size: 16px; margin-right: 10px; background: #eee; border: 1px solid #ccc; color: #555; }
        textarea { flex: 1; padding: 15px; font-size: 16px; font-family: monospace; line-height: 1.6; resize: none; margin-bottom: 15px; border: 1px solid #ddd; }
        
        .btn { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-size: 16px; }
        .btn-save { background: #28a745; color: white; }
        .btn-del { background: #dc3545; color: white; margin-left: 10px; }
        .btn-back { background: #6c757d; color: white; margin-right: 10px; }
        
        /* 简单的加载遮罩 */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 99; font-size: 20px; color: #333; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loading">正在连接 GitHub...</div>

    <div class="toolbar">
        <button class="btn btn-back" onclick="window.close()">关闭</button>
        <input type="text" id="file-path" disabled title="文件路径不可直接修改，请去主页新建或重命名">
        <div>
            <button class="btn btn-save" onclick="saveFile()">保存更改</button>
            <button class="btn btn-del" onclick="deleteFile()">删除此文</button>
        </div>
    </div>

    <textarea id="editor-content" placeholder="输入 Markdown 内容..."></textarea>

<script>
    // ==========================================
    // ⚠️ 必须与 index.html 的配置完全一致
    // ==========================================
    const CONFIG = {
        owner: 'KazamataNeri-Love',  
        repo: 'my-blog-web',
        branch: 'main'
    };
    // ==========================================

    // 获取 URL 参数
    const params = new URLSearchParams(window.location.search);
    const filePath = params.get('path'); // 例如 posts/学习/a.md
    let currentSha = null; // 文件的“指纹”，更新时必须带上

    // 1. 权限与初始化检查
    const token = localStorage.getItem('gh_token');
    if (!token) {
        alert("未授权！请先在主页登录。");
        window.location.href = 'index.html';
    }
    if (!filePath) {
        alert("无效的文件路径");
        window.close();
    }

    // 显示路径
    document.getElementById('file-path').value = filePath;

    // 2. 加载文件内容
    async function loadContent() {
        const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${filePath}?ref=${CONFIG.branch}`;
        try {
            const res = await fetch(url, {
                headers: { 'Authorization': `token ${token}` }
            });
            
            if (!res.ok) throw new Error("文件加载失败: " + res.status);
            
            const data = await res.json();
            currentSha = data.sha; // ❗重要：保存 SHA 用于后续更新

            // Base64 解码 (解决中文乱码)
            const content = decodeURIComponent(escape(window.atob(data.content)));
            document.getElementById('editor-content').value = content;
        } catch (e) {
            alert(e.message);
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    }

    // 3. 保存文件
    async function saveFile() {
        if (!currentSha) return alert("原始文件数据未加载，无法保存");
        
        const content = document.getElementById('editor-content').value;
        const message = `Update ${filePath} via Web Editor`;
        
        // Base64 编码 (解决中文乱码)
        const contentBase64 = btoa(unescape(encodeURIComponent(content)));

        document.getElementById('loading').innerText = "正在保存...";
        document.getElementById('loading').classList.remove('hidden');

        try {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${filePath}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    content: contentBase64,
                    sha: currentSha, // ❗必须带上原始 SHA，否则 GitHub 拒绝更新
                    branch: CONFIG.branch
                })
            });

            if (res.ok) {
                const data = await res.json();
                currentSha = data.content.sha; // 更新本地 SHA，以便连续保存
                alert("保存成功！");
                
                // 尝试刷新父窗口（如果父窗口是 index.html）
                if (window.opener && !window.opener.closed) {
                    window.opener.location.reload(); 
                }
            } else {
                const err = await res.json();
                throw new Error(err.message);
            }
        } catch (e) {
            alert("保存失败: " + e.message);
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    }

    // 4. 删除文件
    async function deleteFile() {
        if (!confirm("确定要永久删除这个文件吗？此操作无法撤销（除非去 Git 历史找回）。")) return;

        document.getElementById('loading').innerText = "正在删除...";
        document.getElementById('loading').classList.remove('hidden');

        try {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${filePath}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Delete ${filePath}`,
                    sha: currentSha,
                    branch: CONFIG.branch
                })
            });

            if (res.ok) {
                alert("删除成功");
                if (window.opener && !window.opener.closed) {
                    window.opener.location.reload();
                }
                window.close();
            } else {
                throw new Error("删除失败");
            }
        } catch (e) {
            alert(e.message);
            document.getElementById('loading').classList.add('hidden');
        }
    }

    // 启动加载
    loadContent();
</script>
</body>
</html>
