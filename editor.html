<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç¼–è¾‘å™¨</title>
    <style>
        body { max-width: 900px; margin: 20px auto; padding: 20px; font-family: sans-serif; background: #fff; }
        .header-area { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #444; }
        input[type="text"] { width: 100%; padding: 12px; font-size: 18px; border: 1px solid #d0d7de; border-radius: 6px; box-sizing: border-box; }
        input:focus { outline: 2px solid #0969da; border-color: transparent; }
        .toolbar { background: #f6f8fa; padding: 8px; border: 1px solid #d0d7de; border-bottom: none; border-radius: 6px 6px 0 0; display: flex; gap: 6px; flex-wrap: wrap; align-items: center;}
        .tool-btn { background: white; border: 1px solid #d0d7de; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; color: #24292f; }
        .tool-btn:hover { background: #f3f4f6; border-color: #8b949e; }
        .tool-sep { width: 1px; height: 20px; background: #d0d7de; margin: 0 5px; }
        textarea { width: 100%; height: 500px; padding: 15px; font-family: "SFMono-Regular", Consolas, monospace; font-size: 15px; line-height: 1.6; border: 1px solid #d0d7de; border-radius: 0 0 6px 6px; box-sizing: border-box; resize: vertical; outline: none; }
        textarea:focus { border-color: #0969da; }
        .footer { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .status { color: #666; font-size: 14px; }
        .btn-save { background: #2da44e; color: white; border: none; padding: 10px 24px; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-save:hover { background: #2c974b; }
        .back-link { text-decoration: none; color: #0969da; }
        #modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index: 999; }
        #modal { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); width: 450px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        #file-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; border-radius: 4px; }
        #file-list li { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; font-size: 14px; }
        #file-list li:hover { background: #f6f8fa; }
        .icon { margin-right: 8px; font-size: 16px; }
    </style>
</head>
<body>
    <div style="margin-bottom:15px">
        <a href="index.html" class="back-link">â† è¿”å›åˆ—è¡¨</a>
    </div>

    <div class="header-area">
        <label>è´´æ–‡æ ‡é¢˜</label>
        <input type="text" id="post-title" placeholder="è¯·è¾“å…¥æ ‡é¢˜...">
    </div>

    <div class="toolbar">
        <button class="tool-btn" onclick="insertMD('**', '**')">B åŠ ç²—</button>
        <button class="tool-btn" onclick="insertMD('*', '*')">I æ–œä½“</button>
        <div class="tool-sep"></div>
        <button class="tool-btn" onclick="insertMD('# ', '')">H1</button>
        <button class="tool-btn" onclick="insertMD('## ', '')">H2</button>
        <div class="tool-sep"></div>
        <button class="tool-btn" onclick="insertTable()">ğŸ“… è¡¨æ ¼</button>
        <button class="tool-btn" onclick="insertMD('> ', '')">â å¼•ç”¨</button>
        <button class="tool-btn" onclick="insertMD('\n---\n', '')">ğŸ“ åˆ†å‰²çº¿</button>
        <div class="tool-sep"></div>
        
        <button class="tool-btn" onclick="document.getElementById('img-upload').click()">ğŸ–¼ï¸ æ’å…¥å›¾ç‰‡</button>
        <input type="file" id="img-upload" accept="image/*" style="display:none">

        <button class="tool-btn" id="openFileBtn" style="margin-left:auto; background:#f0f6fc; color:#0969da">ğŸ“ æ’å…¥æ–‡ä»¶</button>
    </div>

    <textarea id="content" placeholder="åœ¨æ­¤å¼€å§‹æ’°å†™æ­£æ–‡..."></textarea>
    
    <div class="footer">
        <span class="status" id="status-text">åˆå§‹åŒ–ä¸­...</span>
        <button id="saveBtn" class="btn-save">ä¿å­˜è´´æ–‡</button>
    </div>

    <div id="modal-overlay">
        <div id="modal">
            <h3 style="margin-top:0">é€‰æ‹©è¦æ’å…¥çš„æ–‡ä»¶</h3>
            <div id="current-path" style="font-size: 12px; color:#666; margin-bottom:5px;">è·¯å¾„: /</div>
            <ul id="file-list">åŠ è½½ä¸­...</ul>
            <div style="margin-top:15px; text-align:right">
                <button class="tool-btn" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { savePost, getPost, generateAutoFilename, listDir, uploadImage } from "./js/api.js";

        const titleInput = document.getElementById("post-title");
        const contentArea = document.getElementById("content");
        const statusText = document.getElementById("status-text");
        const saveBtn = document.getElementById("saveBtn");

        const params = new URLSearchParams(location.search);
        const editFilename = params.get("edit");
        
        // å…³é”®å˜é‡ï¼šç”¨äºå­˜å‚¨å½“å‰æ“ä½œçš„â€œç›®æ ‡æ–‡ä»¶åâ€
        let currentTargetFilename = "";

        // --- åˆå§‹åŒ–é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹) ---
        async function init() {
            if (editFilename) {
                // === ç¼–è¾‘æ¨¡å¼ ===
                currentTargetFilename = editFilename;
                statusText.innerText = `ç¼–è¾‘æ¨¡å¼: ${currentTargetFilename}`;
                saveBtn.innerText = "æ›´æ–°è´´æ–‡";
                
                try {
                    const fullText = await getPost(editFilename);
                    const lines = fullText.split('\n');
                    if (lines[0].startsWith('# ')) {
                        titleInput.value = lines[0].replace('# ', '').trim();
                        contentArea.value = lines.slice(1).join('\n').trim();
                    } else {
                        titleInput.value = "æ— æ ‡é¢˜";
                        contentArea.value = fullText;
                    }
                } catch(e) { alert("åŠ è½½æ–‡ç« å¤±è´¥"); }
                
            } else {
                // === æ–°å»ºæ¨¡å¼ ===
                // ç«‹å³é¢„è®¡ç®—æ–‡ä»¶åï¼Œä¾‹å¦‚ 2026-1-14-0x0001.md
                // è¿™æ ·åç»­ä¸Šä¼ å›¾ç‰‡æ—¶ï¼Œå°±çŸ¥é“è¯¥å¾€å“ªä¸ªæ–‡ä»¶å¤¹ä¼ äº†
                statusText.innerText = "æ­£åœ¨é¢„åˆ†é…æ–‡ä»¶å...";
                currentTargetFilename = await generateAutoFilename();
                statusText.innerText = `æ–°å»ºæ¨¡å¼ (ç›®æ ‡: ${currentTargetFilename})`;
            }
        }
        init();

        // --- å›¾ç‰‡ä¸Šä¼ é€»è¾‘ ---
        const imgInput = document.getElementById("img-upload");
        imgInput.addEventListener("change", async () => {
            const file = imgInput.files[0];
            if (!file) return;
            if (!currentTargetFilename) return alert("åˆå§‹åŒ–æœªå®Œæˆï¼Œè¯·ç¨åå†è¯•");

            const token = prompt("ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡éªŒè¯ï¼šè¯·è¾“å…¥ Token:");
            if (!token) { imgInput.value = ""; return; }

            statusText.innerText = "æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...";
            
            try {
                // 1. æå–æ–‡ä»¶å¤¹åï¼šå»æ‰ .md åç¼€
                // ä¾‹å¦‚ 2026-1-14-0x0001.md -> 2026-1-14-0x0001
                const folderName = currentTargetFilename.replace(".md", "");

                // 2. è°ƒç”¨ API ä¸Šä¼ åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
                const imageUrl = await uploadImage(file, folderName, token);
                
                const mdImage = `\n![${file.name}](${imageUrl})\n`;
                window.insertMD(mdImage, "");
                
                alert("âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼\nå­˜æ”¾ä½ç½®: images/" + folderName);
                statusText.innerText = "å›¾ç‰‡å·²æ’å…¥";
            } catch (e) {
                alert("âŒ ä¸Šä¼ å¤±è´¥: " + e.message);
                statusText.innerText = "ä¸Šä¼ å‡ºé”™";
            } finally {
                imgInput.value = "";
            }
        });

        // --- ä¿å­˜é€»è¾‘ ---
        saveBtn.onclick = async () => {
            const title = titleInput.value.trim();
            const body = contentArea.value;

            if (!title) return alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼");
            if (!currentTargetFilename) return alert("ç³»ç»Ÿé”™è¯¯ï¼šç›®æ ‡æ–‡ä»¶åæœªç”Ÿæˆ");

            const finalContent = `# ${title}\n\n${body}`;
            const token = prompt("ğŸ” è¯·è¾“å…¥ Token ä»¥ä¿å­˜è´´æ–‡:");
            if (!token) return;

            statusText.innerText = "æ­£åœ¨ä¿å­˜...";
            saveBtn.disabled = true;

            try {
                // ç›´æ¥ä½¿ç”¨æˆ‘ä»¬åˆå§‹åŒ–æ—¶ç¡®å®šçš„ currentTargetFilename
                await savePost(currentTargetFilename, finalContent, token);
                alert(`âœ… ä¿å­˜æˆåŠŸï¼\næ–‡ä»¶: ${currentTargetFilename}`);
                window.location.href = "index.html";
            } catch (e) {
                alert("âŒ ä¿å­˜å¤±è´¥: " + e.message);
                saveBtn.disabled = false;
                statusText.innerText = "ä¿å­˜å¤±è´¥";
            }
        };

        // --- å·¥å…·æ è¾…åŠ©å‡½æ•° (ä¿æŒä¸å˜) ---
        window.insertMD = (prefix, suffix) => {
            const start = contentArea.selectionStart;
            const end = contentArea.selectionEnd;
            const text = contentArea.value;
            const selection = text.substring(start, end);
            contentArea.value = text.substring(0, start) + prefix + selection + suffix + text.substring(end);
            contentArea.focus();
            contentArea.selectionStart = start + prefix.length;
            contentArea.selectionEnd = start + prefix.length + selection.length;
        };
        window.insertTable = () => {
            const table = `\n| è¡¨å¤´1 | è¡¨å¤´2 |\n| --- | --- |\n| å†…å®¹1 | å†…å®¹2 |\n`;
            window.insertMD(table, "");
        };

        // --- æ–‡ä»¶é€‰æ‹©å™¨é€»è¾‘ (ä¿æŒä¸å˜) ---
        let currentPath = "";
        document.getElementById("openFileBtn").onclick = () => {
            document.getElementById("modal-overlay").style.display = "block";
            loadFiles("");
        };
        window.closeModal = () => { document.getElementById("modal-overlay").style.display = "none"; };
        async function loadFiles(path) {
            currentPath = path;
            document.getElementById("current-path").innerText = "è·¯å¾„: " + (path || "æ ¹ç›®å½•");
            const listEl = document.getElementById("file-list");
            listEl.innerHTML = "<li>âŒ› åŠ è½½ä¸­...</li>";
            const items = await listDir(path);
            listEl.innerHTML = "";
            if (path !== "") {
                const li = document.createElement("li");
                li.innerHTML = `<span class="icon">ğŸ”™</span> .. (è¿”å›ä¸Šçº§)`;
                li.onclick = () => {
                    const parts = currentPath.split('/');
                    parts.pop();
                    loadFiles(parts.join('/'));
                };
                listEl.appendChild(li);
            }
            items.sort((a, b) => (a.type === b.type ? 0 : a.type === "dir" ? -1 : 1));
            items.forEach(item => {
                const li = document.createElement("li");
                if (item.type === "dir") {
                    li.innerHTML = `<span class="icon">ğŸ“‚</span> ${item.name}`;
                    li.onclick = () => loadFiles(item.path);
                } else {
                    li.innerHTML = `<span class="icon">ğŸ“„</span> ${item.name}`;
                    li.onclick = () => {
                        window.insertMD(`\n<div class="file-card"><span class="file-name">ğŸ“„ ${item.name}</span><span class="file-download" data-path="${item.path}">â¬‡ï¸ ä¸‹è½½</span></div>\n`, "");
                        closeModal();
                    };
                }
                listEl.appendChild(li);
            });
        }
    </script>
</body>
</html>
