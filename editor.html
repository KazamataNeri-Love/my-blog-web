<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç¼–è¾‘å™¨</title>
    <!-- å¼•å…¥ Marked è§£æå™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥ FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { 
            max-width: 900px; margin: 20px auto; padding: 20px; 
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            background: #fff; color: #333;
        }
        
        a { text-decoration: none; }
        
        .header-area { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #444; font-size: 14px;}
        
        input[type="text"], input[type="password"] { 
            width: 100%; padding: 10px; font-size: 14px; 
            border: 1px solid #d0d7de; border-radius: 6px; box-sizing: border-box; 
            font-family: inherit; margin-bottom: 10px;
        }
        input:focus { outline: 2px solid #0969da; border-color: transparent; }

        /* --- æ ‡ç­¾é¡µåˆ‡æ¢æ  --- */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid #d0d7de;
            margin-bottom: 0; 
        }
        .tab-btn {
            background: transparent;
            border: 1px solid transparent;
            border-bottom: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #57606a;
            border-radius: 6px 6px 0 0;
            font-family: inherit;
            margin-bottom: -1px; 
        }
        .tab-btn:hover { color: #0969da; }
        .tab-btn.active {
            background: #fff;
            border-color: #d0d7de;
            border-bottom-color: #fff;
            color: #0969da;
        }

        /* --- ç¼–è¾‘åŒºåŸŸ --- */
        #editor-view { display: block; }
        
        .toolbar { 
            background: #f6f8fa; padding: 8px; 
            border: 1px solid #d0d7de; border-top: none; 
            border-bottom: none; 
            display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
        }
        .tool-btn { 
            background: white; border: 1px solid #d0d7de; padding: 5px 10px; 
            border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; 
            color: #24292f; font-family: inherit; display: flex; align-items: center; gap: 5px;
        }
        .tool-btn:hover { background: #f3f4f6; border-color: #8b949e; }
        .tool-sep { width: 1px; height: 20px; background: #d0d7de; margin: 0 5px; }
        
        textarea { 
            width: 100%; height: 500px; padding: 15px; 
            font-family: inherit; font-size: 14px; line-height: 1.6; 
            border: 1px solid #d0d7de; border-radius: 0 0 6px 6px; 
            box-sizing: border-box; resize: vertical; outline: none; 
        }
        textarea:focus { border-color: #0969da; }

        /* --- é¢„è§ˆåŒºåŸŸ --- */
        #preview-view { 
            display: none; 
            border: 1px solid #d0d7de; 
            border-top: none;
            border-radius: 0 0 6px 6px;
            min-height: 500px;
            padding: 40px;
            background: #191919; 
        }

        /* é¢„è§ˆæ ·å¼ */
        .markdown-body { line-height: 1.8; color: #d4d4d4; font-size: 14px; }
        .markdown-body h1, .markdown-body h2 { color: #fff; border-bottom: 1px solid #333; }
        .markdown-body a { color: #3794ff; text-decoration: none; }
        .markdown-body blockquote { border-left: 0.25em solid #3794ff; background: #222; color: #999; }
        .markdown-body code { background-color: rgba(110,118,129,0.4); font-family: inherit; }
        .markdown-body pre { background-color: #161b22; border: 1px solid #30363d; padding: 16px; overflow: auto; }
        .markdown-body table { border-collapse: collapse; width: 100%; }
        .markdown-body th, .markdown-body td { border: 1px solid #30363d; padding: 6px 13px; }
        .markdown-body img { max-width: 100%; border-radius: 4px; background: #fff; }

        /* --- åº•éƒ¨ä¸æŒ‰é’® --- */
        .footer { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .status { color: #666; font-size: 13px; }
        .btn-save { 
            background: #2da44e; color: white; border: none; padding: 8px 20px; 
            border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; font-family: inherit;
        }
        .btn-save:hover { background: #2c974b; }
        
        .back-link { color: #0969da; font-size: 14px; display: inline-flex; align-items: center; gap: 5px;}
        
        /* --- é€šç”¨æ¨¡æ€æ¡† --- */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); width: 400px; max-width: 90%; position: relative; }
        .modal h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-footer { margin-top: 15px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
        
        /* å›¾ç‰‡é¢„è§ˆåŒºåŸŸ */
        #img-preview-box { 
            width: 100%; height: 200px; background: #f6f8fa; 
            display: flex; align-items: center; justify-content: center; 
            border: 1px dashed #d0d7de; border-radius: 6px; margin-bottom: 15px; overflow: hidden;
        }
        #img-preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        /* æ–‡ä»¶åˆ—è¡¨ */
        #file-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        #file-list li { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; font-size: 13px; }
        #file-list li:hover { background: #f6f8fa; }
    </style>
</head>
<body>
    <div style="margin-bottom:15px">
        <a href="index.html" class="back-link"><i class="fa-solid fa-arrow-left"></i> è¿”å›åˆ—è¡¨</a>
    </div>

    <div class="header-area">
        <label>è´´æ–‡æ ‡é¢˜</label>
        <input type="text" id="post-title" placeholder="è¯·è¾“å…¥æ ‡é¢˜ (å»ºè®®ä½¿ç”¨ä¸­æ–‡)...">
    </div>

    <!-- æ ‡ç­¾åˆ‡æ¢ -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('edit')" id="tab-edit">
            <i class="fa-solid fa-pen-to-square"></i> æ’°å†™
        </button>
        <button class="tab-btn" onclick="switchTab('preview')" id="tab-preview">
            <i class="fa-solid fa-eye"></i> é¢„è§ˆ
        </button>
    </div>

    <!-- ç¼–è¾‘è§†å›¾ -->
    <div id="editor-view">
        <div class="toolbar">
            <button class="tool-btn" onclick="insertMD('**', '**')"><b>B</b></button>
            <button class="tool-btn" onclick="insertMD('*', '*')"><i>I</i></button>
            <div class="tool-sep"></div>
            <button class="tool-btn" onclick="insertMD('# ', '')">H1</button>
            <button class="tool-btn" onclick="insertMD('## ', '')">H2</button>
            <div class="tool-sep"></div>
            <button class="tool-btn" onclick="insertTable()"><i class="fa-solid fa-table"></i> è¡¨æ ¼</button>
            <button class="tool-btn" onclick="insertMD('> ', '')"><i class="fa-solid fa-quote-right"></i> å¼•ç”¨</button>
            <button class="tool-btn" onclick="insertMD('\n---\n', '')"><i class="fa-solid fa-ruler-horizontal"></i> åˆ†å‰²</button>
            <div class="tool-sep"></div>
            
            <button class="tool-btn" onclick="triggerFileSelect()"><i class="fa-regular fa-image"></i> å›¾ç‰‡</button>
            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
            <input type="file" id="img-upload-input" accept="image/*" style="display:none">

            <button class="tool-btn" id="openFileBtn" style="margin-left:auto; background:#f0f6fc; color:#0969da">
                <i class="fa-solid fa-paperclip"></i> æ–‡ä»¶
            </button>
        </div>

        <textarea id="content" placeholder="åœ¨æ­¤å¼€å§‹æ’°å†™æ­£æ–‡... æ”¯æŒ Markdown è¯­æ³•"></textarea>
    </div>

    <!-- é¢„è§ˆè§†å›¾ -->
    <div id="preview-view">
        <div id="preview-content" class="markdown-body"></div>
    </div>
    
    <div class="footer">
        <span class="status" id="status-text">å‡†å¤‡å°±ç»ª</span>
        <button id="saveBtn" class="btn-save"><i class="fa-solid fa-floppy-disk"></i> ä¿å­˜è´´æ–‡</button>
    </div>

    <!-- 1. å›¾ç‰‡ä¸Šä¼ æ¨¡æ€æ¡† (æ–°åŠŸèƒ½) -->
    <div id="img-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3>æ’å…¥å›¾ç‰‡</h3>
            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div id="img-preview-box">
                <span style="color:#999">æš‚æ— é¢„è§ˆ</span>
            </div>
            
            <label style="font-size:12px;">Token (ç”¨äºé‰´æƒ):</label>
            <input type="password" id="upload-token" placeholder="è¯·è¾“å…¥ GitHub Token">
            
            <div class="modal-footer">
                <button class="tool-btn" onclick="closeImgModal()">å–æ¶ˆ</button>
                <button class="btn-save" id="btn-confirm-upload">ç¡®è®¤ä¸Šä¼ </button>
            </div>
        </div>
    </div>

    <!-- 2. æ–‡ä»¶é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="file-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3>é€‰æ‹©è¦æ’å…¥çš„æ–‡ä»¶</h3>
            <div id="current-path" style="font-size: 12px; color:#666; margin-bottom:5px;">è·¯å¾„: /</div>
            <ul id="file-list">åŠ è½½ä¸­...</ul>
            <div class="modal-footer">
                <button class="tool-btn" onclick="document.getElementById('file-modal-overlay').style.display='none'">å…³é—­</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { savePost, getPost, listDir, uploadImage } from "./js/api.js";

        const titleInput = document.getElementById("post-title");
        const contentArea = document.getElementById("content");
        const statusText = document.getElementById("status-text");
        const saveBtn = document.getElementById("saveBtn");
        const previewContent = document.getElementById("preview-content");

        const imgInput = document.getElementById("img-upload-input");
        const imgModal = document.getElementById("img-modal-overlay");
        const imgPreviewBox = document.getElementById("img-preview-box");
        const uploadTokenInput = document.getElementById("upload-token");
        const confirmUploadBtn = document.getElementById("btn-confirm-upload");

        // ä¸´æ—¶å­˜å‚¨é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶
        let selectedImgFile = null;

        const params = new URLSearchParams(location.search);
        const editFilename = params.get("edit") ? decodeURIComponent(params.get("edit")) : null;
        
        // --- åˆå§‹åŒ– ---
        async function init() {
            if (editFilename) {
                statusText.innerText = `æ­£åœ¨ç¼–è¾‘: ${editFilename}`;
                saveBtn.innerHTML = `<i class="fa-solid fa-rotate"></i> æ›´æ–°è´´æ–‡`;
                try {
                    const fullText = await getPost(editFilename);
                    const lines = fullText.split('\n');
                    if (lines[0].startsWith('# ')) {
                        titleInput.value = lines[0].replace('# ', '').trim();
                        contentArea.value = lines.slice(1).join('\n').trim();
                    } else {
                        titleInput.value = editFilename.replace(".md", "").replace(/^\d{4}-\d{2}-\d{2}-/, "");
                        contentArea.value = fullText;
                    }
                } catch(e) { alert("åŠ è½½å¤±è´¥: " + e.message); }
            } else {
                statusText.innerText = "æ–°å»ºæ¨¡å¼";
            }
        }
        init();

        // --- æ ‡ç­¾é¡µåˆ‡æ¢ ---
        window.switchTab = (tab) => {
            const editorView = document.getElementById("editor-view");
            const previewView = document.getElementById("preview-view");
            const btnEdit = document.getElementById("tab-edit");
            const btnPreview = document.getElementById("tab-preview");

            if (tab === 'edit') {
                editorView.style.display = "block";
                previewView.style.display = "none";
                btnEdit.classList.add("active");
                btnPreview.classList.remove("active");
            } else {
                editorView.style.display = "none";
                previewView.style.display = "block";
                btnEdit.classList.remove("active");
                btnPreview.classList.add("active");

                const rawMarkdown = contentArea.value;
                const title = titleInput.value.trim();
                const previewMd = `# ${title || 'æ— æ ‡é¢˜'}\n\n${rawMarkdown}`;
                
                previewContent.innerHTML = marked.parse(previewMd);
                previewContent.querySelectorAll('img').forEach(img => {
                    img.onerror = () => { img.style.border = "1px solid #555"; img.alt += " (æœªæ‰¾åˆ°)"; };
                });
            }
        };

        // --- å›¾ç‰‡ä¸Šä¼ æ–°é€»è¾‘ ---
        
        // 1. ç‚¹å‡»æŒ‰é’®è§¦å‘æ–‡ä»¶é€‰æ‹©
        window.triggerFileSelect = () => {
            const title = titleInput.value.trim();
            if(!editFilename && !title) {
                alert("âš ï¸ è¯·å…ˆè¾“å…¥ã€è´´æ–‡æ ‡é¢˜ã€‘ï¼Œç³»ç»Ÿéœ€è¦ç”¨æ ‡é¢˜æ¥åˆ›å»ºå›¾ç‰‡æ–‡ä»¶å¤¹ï¼");
                titleInput.focus();
                return;
            }
            imgInput.click();
        };

        // 2. æ–‡ä»¶é€‰ä¸­åï¼Œæ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
        imgInput.addEventListener("change", () => {
            const file = imgInput.files[0];
            if (!file) return;
            selectedImgFile = file;

            // æœ¬åœ°é¢„è§ˆ (FileReader)
            const reader = new FileReader();
            reader.onload = (e) => {
                imgPreviewBox.innerHTML = `<img src="${e.target.result}" style="max-height:100%">`;
            };
            reader.readAsDataURL(file);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            imgModal.style.display = "flex";
            // å°è¯•ä» localStorage è·å– token å¡«å…… (å¯é€‰ä¼˜åŒ–)
            const savedToken = localStorage.getItem("github_token");
            if(savedToken) uploadTokenInput.value = savedToken;
        });

        // 3. å…³é—­æ¨¡æ€æ¡†
        window.closeImgModal = () => {
            imgModal.style.display = "none";
            imgInput.value = ""; // æ¸…ç©º input é˜²æ­¢é‡å¤è§¦å‘
            selectedImgFile = null;
        };

        // 4. ç¡®è®¤ä¸Šä¼ 
        confirmUploadBtn.onclick = async () => {
            const token = uploadTokenInput.value.trim();
            if(!token) return alert("è¯·è¾“å…¥ Token");
            
            // ä¿å­˜ token æ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨
            localStorage.setItem("github_token", token);
            
            confirmUploadBtn.disabled = true;
            confirmUploadBtn.innerText = "ä¸Šä¼ ä¸­...";

            try {
                const title = titleInput.value.trim();
                // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ–‡ä»¶å¤¹å
                let folderName = "";
                if(editFilename) {
                    folderName = editFilename.replace(".md", ""); 
                } else {
                    const now = new Date();
                    const y = now.getFullYear();
                    const m = String(now.getMonth() + 1).padStart(2, '0');
                    const d = String(now.getDate()).padStart(2, '0');
                    folderName = `${y}-${m}-${d}-${title}`;
                }

                const imageUrl = await uploadImage(selectedImgFile, folderName, token);
                
                // æ’å…¥ Markdown
                const mdImage = `\n![${selectedImgFile.name}](${imageUrl})\n`;
                window.insertMD(mdImage, "");
                
                // å…³é—­å¹¶æç¤º
                closeImgModal();
                statusText.innerText = "âœ… å›¾ç‰‡å·²æ’å…¥";
                
                // å¯é€‰ï¼šå¦‚æœæƒ³ä¸Šä¼ åç«‹å³çœ‹æ•ˆæœï¼Œå¯ä»¥è‡ªåŠ¨åˆ‡åˆ° Preview æ ‡ç­¾ï¼Œä½†å¯èƒ½ä¼šæ‰“æ–­å†™ä½œ
                // window.switchTab('preview'); 

            } catch (e) {
                alert("âŒ ä¸Šä¼ å¤±è´¥: " + e.message);
            } finally {
                confirmUploadBtn.disabled = false;
                confirmUploadBtn.innerText = "ç¡®è®¤ä¸Šä¼ ";
            }
        };

        // --- è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ–‡ä»¶å ---
        function generateTargetName(title) {
            if(editFilename) return editFilename.replace(".md", ""); 
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}-${title}`;
        }

        // --- ä¿å­˜é€»è¾‘ ---
        saveBtn.onclick = async () => {
            const title = titleInput.value.trim();
            const body = contentArea.value;

            if (!title) return alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼");

            const finalContent = `# ${title}\n\n${body}`;
            
            // ä½¿ç”¨æ–°æ¨¡æ€æ¡†åŒæ ·çš„ Token å­˜å‚¨æœºåˆ¶ï¼Œæˆ–è€…å¤ç”¨ modal?
            // ä¸ºäº†ç®€å•ï¼Œè¿™é‡Œè¿˜æ˜¯ç”¨ promptï¼Œæˆ–è€…ä½ å¯ä»¥ä¹Ÿåšä¸€ä¸ª Token æ¨¡æ€æ¡†
            let token = localStorage.getItem("github_token");
            if (!token) {
                token = prompt("ğŸ” è¯·è¾“å…¥ Token ä»¥ä¿å­˜:");
            } else {
                // å¦‚æœæœ‰ç¼“å­˜ï¼Œç¨å¾®ç¡®è®¤ä¸€ä¸‹ï¼Œæˆ–è€…ç›´æ¥ä¿å­˜
                // è¿™é‡Œä¸ºäº†å®‰å…¨è¿˜æ˜¯è®©ç”¨æˆ·ç¡®è®¤ä¸€ä¸‹ï¼Œæˆ–è€…ç›´æ¥é™é»˜ä¿å­˜
                 const useCache = confirm("æ£€æµ‹åˆ°ç¼“å­˜çš„ Tokenï¼Œæ˜¯å¦ç›´æ¥ä½¿ç”¨ï¼Ÿ");
                 if(!useCache) token = prompt("ğŸ” è¯·è¾“å…¥ Token ä»¥ä¿å­˜:");
            }
            
            if (!token) return;
            localStorage.setItem("github_token", token);

            statusText.innerText = "æ­£åœ¨ä¿å­˜...";
            saveBtn.disabled = true;

            try {
                const targetFilename = generateTargetName(title) + ".md";
                await savePost(targetFilename, finalContent, token);
                alert(`âœ… ä¿å­˜æˆåŠŸï¼`);
                window.location.href = "index.html";
            } catch (e) {
                alert("âŒ ä¿å­˜å¤±è´¥: " + e.message);
                saveBtn.disabled = false;
                statusText.innerText = "ä¿å­˜å¤±è´¥";
            }
        };

        // --- å·¥å…·æ å‡½æ•° ---
        window.insertMD = (prefix, suffix) => {
            const start = contentArea.selectionStart;
            const end = contentArea.selectionEnd;
            const text = contentArea.value;
            contentArea.value = text.substring(0, start) + prefix + text.substring(start, end) + suffix + text.substring(end);
            contentArea.focus();
            contentArea.selectionStart = start + prefix.length;
            contentArea.selectionEnd = end + prefix.length;
        };
        window.insertTable = () => window.insertMD('\n| è¡¨å¤´1 | è¡¨å¤´2 |\n| --- | --- |\n| å†…å®¹1 | å†…å®¹2 |\n', '');
        
        // --- æ–‡ä»¶é€‰æ‹©å™¨é€»è¾‘ ---
        let currentPath = "";
        document.getElementById("openFileBtn").onclick = () => {
            document.getElementById("file-modal-overlay").style.display = "flex";
            loadFiles("");
        };
        
        async function loadFiles(path) {
            currentPath = path;
            document.getElementById("current-path").innerText = "è·¯å¾„: " + (path || "æ ¹ç›®å½•");
            const listEl = document.getElementById("file-list");
            listEl.innerHTML = "<li>âŒ› åŠ è½½ä¸­...</li>";
            const items = await listDir(path);
            listEl.innerHTML = "";
            if (path !== "") {
                const li = document.createElement("li");
                li.innerHTML = `<span class="icon">ğŸ”™</span> .. (è¿”å›ä¸Šçº§)`;
                li.onclick = () => {
                    const parts = currentPath.split('/');
                    parts.pop();
                    loadFiles(parts.join('/'));
                };
                listEl.appendChild(li);
            }
            items.sort((a, b) => (a.type === b.type ? 0 : a.type === "dir" ? -1 : 1));
            items.forEach(item => {
                const li = document.createElement("li");
                if (item.type === "dir") {
                    li.innerHTML = `<span class="icon">ğŸ“‚</span> ${item.name}`;
                    li.onclick = () => loadFiles(item.path);
                } else {
                    li.innerHTML = `<span class="icon">ğŸ“„</span> ${item.name}`;
                    li.onclick = () => {
                        window.insertMD(`\n<div class="file-card"><span class="file-name">ğŸ“„ ${item.name}</span><span class="file-download" data-path="${item.path}">â¬‡ï¸ ä¸‹è½½</span></div>\n`, "");
                        document.getElementById("file-modal-overlay").style.display='none';
                    };
                }
                listEl.appendChild(li);
            });
        }
    </script>
</body>
</html>
