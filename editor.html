<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç¼–è¾‘å™¨</title>
    <!-- 1. å¼•å…¥ Marked è§£æå™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥ FontAwesome (ç”¨äºå›¾æ ‡) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- åŸºç¡€æ ·å¼ (ä¿æŒç¼–è¾‘å™¨åŸæœ¬çš„æ˜äº®é£æ ¼ï¼Œä½†æ¢ç”¨ç­‰å®½å­—ä½“) --- */
        body { 
            max-width: 900px; margin: 20px auto; padding: 20px; 
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            background: #fff; color: #333;
        }
        
        a { text-decoration: none; }
        
        .header-area { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #444; font-size: 14px;}
        
        input[type="text"] { 
            width: 100%; padding: 10px; font-size: 16px; 
            border: 1px solid #d0d7de; border-radius: 6px; box-sizing: border-box; 
            font-family: inherit;
        }
        input:focus { outline: 2px solid #0969da; border-color: transparent; }

        /* --- æ ‡ç­¾é¡µåˆ‡æ¢æ  --- */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid #d0d7de;
            margin-bottom: 0; /* ç´§è´´ä¸‹æ–¹å†…å®¹ */
        }
        .tab-btn {
            background: transparent;
            border: 1px solid transparent;
            border-bottom: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #57606a;
            border-radius: 6px 6px 0 0;
            font-family: inherit;
            margin-bottom: -1px; /* ç›–ä½åº•è¾¹æ¡† */
        }
        .tab-btn:hover { color: #0969da; }
        .tab-btn.active {
            background: #fff;
            border-color: #d0d7de;
            border-bottom-color: #fff; /* é®æŒ¡åº•çº¿ï¼Œå½¢æˆè¿é€šæ•ˆæœ */
            color: #0969da;
        }

        /* --- ç¼–è¾‘åŒºåŸŸå®¹å™¨ --- */
        #editor-view { display: block; }
        
        .toolbar { 
            background: #f6f8fa; padding: 8px; 
            border: 1px solid #d0d7de; border-top: none; /* ä¸Šæ–¹ç”± Tab å¤„ç† */
            border-bottom: none; 
            display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
        }
        .tool-btn { 
            background: white; border: 1px solid #d0d7de; padding: 5px 10px; 
            border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; 
            color: #24292f; font-family: inherit; display: flex; align-items: center; gap: 5px;
        }
        .tool-btn:hover { background: #f3f4f6; border-color: #8b949e; }
        .tool-sep { width: 1px; height: 20px; background: #d0d7de; margin: 0 5px; }
        
        textarea { 
            width: 100%; height: 500px; padding: 15px; 
            font-family: inherit; font-size: 14px; line-height: 1.6; 
            border: 1px solid #d0d7de; border-radius: 0 0 6px 6px; 
            box-sizing: border-box; resize: vertical; outline: none; 
        }
        textarea:focus { border-color: #0969da; }

        /* --- é¢„è§ˆåŒºåŸŸå®¹å™¨ (æ¨¡æ‹Ÿ index.html çš„æ·±è‰²æ¨¡å¼) --- */
        #preview-view { 
            display: none; 
            border: 1px solid #d0d7de; /* å¤–æ¡†ä¿æŒæµ…è‰²ï¼Œå†…éƒ¨æ·±è‰² */
            border-top: none;
            border-radius: 0 0 6px 6px;
            min-height: 500px;
            padding: 40px;
            background: #191919; /* å¯¹åº” var(--bg-main) */
        }

        /* é¢„è§ˆå†…å®¹çš„æ·±è‰²æ ·å¼ (ä» index.html ç§»æ¤) */
        .markdown-body { line-height: 1.8; color: #d4d4d4; font-size: 14px; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { 
            color: #fff; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; 
        }
        .markdown-body h1 { font-size: 2em; border-bottom: 1px solid #333; padding-bottom: 0.3em; }
        .markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid #333; padding-bottom: 0.3em; }
        .markdown-body p { margin-bottom: 16px; }
        .markdown-body a { color: #3794ff; text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body blockquote {
            padding: 0 1em; color: #999; border-left: 0.25em solid #3794ff;
            margin: 0 0 16px 0; background: #222; padding: 10px 15px; border-radius: 0 4px 4px 0;
        }
        .markdown-body code {
            padding: 0.2em 0.4em; margin: 0; font-size: 85%; background-color: rgba(110,118,129,0.4);
            border-radius: 6px; font-family: inherit;
        }
        .markdown-body pre {
            padding: 16px; overflow: auto; font-size: 85%; line-height: 1.45;
            background-color: #161b22; border-radius: 6px; border: 1px solid #30363d;
        }
        .markdown-body pre code { background-color: transparent; padding: 0; }
        .markdown-body table { border-collapse: collapse; width: 100%; margin-bottom: 16px; }
        .markdown-body table th, .markdown-body table td { padding: 6px 13px; border: 1px solid #30363d; }
        .markdown-body table th { font-weight: 600; background-color: #161b22; }
        .markdown-body table tr { background-color: #191919; }
        .markdown-body table tr:nth-child(2n) { background-color: #161b22; }
        .markdown-body img { max-width: 100%; background-color: #fff; border-radius: 4px; }

        /* --- åº•éƒ¨ä¸æ¨¡æ€æ¡† --- */
        .footer { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .status { color: #666; font-size: 13px; }
        .btn-save { 
            background: #2da44e; color: white; border: none; padding: 8px 20px; 
            border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; font-family: inherit;
        }
        .btn-save:hover { background: #2c974b; }
        .btn-save:disabled { background: #94d3a2; cursor: not-allowed; }
        
        .back-link { color: #0969da; font-size: 14px; display: inline-flex; align-items: center; gap: 5px;}
        
        /* æ–‡ä»¶å¼¹çª—æ ·å¼ */
        #modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index: 999; }
        #modal { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); width: 450px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        #file-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; border-radius: 4px; }
        #file-list li { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; font-size: 13px; }
        #file-list li:hover { background: #f6f8fa; }
        .icon { margin-right: 8px; font-size: 14px; }
    </style>
</head>
<body>
    <div style="margin-bottom:15px">
        <a href="index.html" class="back-link"><i class="fa-solid fa-arrow-left"></i> è¿”å›åˆ—è¡¨</a>
    </div>

    <div class="header-area">
        <label>è´´æ–‡æ ‡é¢˜</label>
        <input type="text" id="post-title" placeholder="è¯·è¾“å…¥æ ‡é¢˜ (å»ºè®®ä½¿ç”¨ä¸­æ–‡)...">
    </div>

    <!-- 2. æ–°å¢ï¼šæ ‡ç­¾åˆ‡æ¢æŒ‰é’® -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('edit')" id="tab-edit">
            <i class="fa-solid fa-pen-to-square"></i> æ’°å†™
        </button>
        <button class="tab-btn" onclick="switchTab('preview')" id="tab-preview">
            <i class="fa-solid fa-eye"></i> é¢„è§ˆ
        </button>
    </div>

    <!-- ç¼–è¾‘è§†å›¾ (Toolbar + Textarea) -->
    <div id="editor-view">
        <div class="toolbar">
            <button class="tool-btn" onclick="insertMD('**', '**')"><b>B</b> åŠ ç²—</button>
            <button class="tool-btn" onclick="insertMD('*', '*')"><i>I</i> æ–œä½“</button>
            <div class="tool-sep"></div>
            <button class="tool-btn" onclick="insertMD('# ', '')">H1</button>
            <button class="tool-btn" onclick="insertMD('## ', '')">H2</button>
            <div class="tool-sep"></div>
            <button class="tool-btn" onclick="insertTable()"><i class="fa-solid fa-table"></i> è¡¨æ ¼</button>
            <button class="tool-btn" onclick="insertMD('> ', '')"><i class="fa-solid fa-quote-right"></i> å¼•ç”¨</button>
            <button class="tool-btn" onclick="insertMD('\n---\n', '')"><i class="fa-solid fa-ruler-horizontal"></i> åˆ†å‰²çº¿</button>
            <div class="tool-sep"></div>
            
            <button class="tool-btn" onclick="triggerImgUpload()"><i class="fa-regular fa-image"></i> å›¾ç‰‡</button>
            <input type="file" id="img-upload" accept="image/*" style="display:none">

            <button class="tool-btn" id="openFileBtn" style="margin-left:auto; background:#f0f6fc; color:#0969da">
                <i class="fa-solid fa-paperclip"></i> æ’å…¥æ–‡ä»¶
            </button>
        </div>

        <textarea id="content" placeholder="åœ¨æ­¤å¼€å§‹æ’°å†™æ­£æ–‡... æ”¯æŒ Markdown è¯­æ³•"></textarea>
    </div>

    <!-- 3. æ–°å¢ï¼šé¢„è§ˆè§†å›¾ (é»˜è®¤éšè—) -->
    <div id="preview-view">
        <div id="preview-content" class="markdown-body">
            <!-- æ¸²æŸ“åçš„ HTML å°†æ”¾åœ¨è¿™é‡Œ -->
        </div>
    </div>
    
    <div class="footer">
        <span class="status" id="status-text">å‡†å¤‡å°±ç»ª</span>
        <button id="saveBtn" class="btn-save"><i class="fa-solid fa-floppy-disk"></i> ä¿å­˜è´´æ–‡</button>
    </div>

    <!-- æ–‡ä»¶é€‰æ‹©å¼¹çª— (ä¿æŒä¸å˜) -->
    <div id="modal-overlay">
        <div id="modal">
            <h3 style="margin-top:0">é€‰æ‹©è¦æ’å…¥çš„æ–‡ä»¶</h3>
            <div id="current-path" style="font-size: 12px; color:#666; margin-bottom:5px;">è·¯å¾„: /</div>
            <ul id="file-list">åŠ è½½ä¸­...</ul>
            <div style="margin-top:15px; text-align:right">
                <button class="tool-btn" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { savePost, getPost, listDir, uploadImage } from "./js/api.js";

        const titleInput = document.getElementById("post-title");
        const contentArea = document.getElementById("content");
        const statusText = document.getElementById("status-text");
        const saveBtn = document.getElementById("saveBtn");
        const previewContent = document.getElementById("preview-content");

        const params = new URLSearchParams(location.search);
        const editFilename = params.get("edit") ? decodeURIComponent(params.get("edit")) : null;
        
        // --- åˆå§‹åŒ– ---
        async function init() {
            if (editFilename) {
                statusText.innerText = `æ­£åœ¨ç¼–è¾‘: ${editFilename}`;
                saveBtn.innerHTML = `<i class="fa-solid fa-rotate"></i> æ›´æ–°è´´æ–‡`;
                
                try {
                    const fullText = await getPost(editFilename);
                    const lines = fullText.split('\n');
                    
                    // å°è¯•åˆ†ç¦»æ ‡é¢˜å’Œæ­£æ–‡
                    if (lines[0].startsWith('# ')) {
                        titleInput.value = lines[0].replace('# ', '').trim();
                        contentArea.value = lines.slice(1).join('\n').trim();
                    } else {
                        const nameWithoutDate = editFilename.replace(".md", "").replace(/^\d{4}-\d{2}-\d{2}-/, "");
                        titleInput.value = nameWithoutDate;
                        contentArea.value = fullText;
                    }
                } catch(e) { alert("åŠ è½½å¤±è´¥: " + e.message); }
            } else {
                statusText.innerText = "æ–°å»ºæ¨¡å¼";
            }
        }
        init();

        // --- æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘ ---
        window.switchTab = (tab) => {
            const editorView = document.getElementById("editor-view");
            const previewView = document.getElementById("preview-view");
            const btnEdit = document.getElementById("tab-edit");
            const btnPreview = document.getElementById("tab-preview");

            if (tab === 'edit') {
                editorView.style.display = "block";
                previewView.style.display = "none";
                btnEdit.classList.add("active");
                btnPreview.classList.remove("active");
            } else {
                // åˆ‡æ¢åˆ°é¢„è§ˆæ—¶ï¼šæ‰§è¡Œæ¸²æŸ“
                editorView.style.display = "none";
                previewView.style.display = "block";
                btnEdit.classList.remove("active");
                btnPreview.classList.add("active");

                // è·å–å½“å‰å†…å®¹å¹¶æ¸²æŸ“
                const rawMarkdown = contentArea.value;
                const title = titleInput.value.trim();
                
                // æ¨¡æ‹Ÿæ–‡ç« ç»“æ„ï¼šåŠ ä¸Š H1 æ ‡é¢˜
                const previewMd = `# ${title || 'æ— æ ‡é¢˜'}\n\n${rawMarkdown}`;
                
                // ä½¿ç”¨ marked æ¸²æŸ“
                previewContent.innerHTML = marked.parse(previewMd);
                
                // å¤„ç†å›¾ç‰‡é”™è¯¯
                previewContent.querySelectorAll('img').forEach(img => {
                    img.onerror = () => { img.style.border = "1px solid #555"; img.alt += " (æœªæ‰¾åˆ°)"; };
                });
            }
        };

        // --- è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆç›®æ ‡æ–‡ä»¶å ---
        function generateTargetName(title) {
            if(editFilename) return editFilename.replace(".md", ""); 
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}-${title}`;
        }

        // --- å›¾ç‰‡ä¸Šä¼  ---
        window.triggerImgUpload = () => {
            const title = titleInput.value.trim();
            if(!editFilename && !title) {
                alert("âš ï¸ è¯·å…ˆè¾“å…¥ã€è´´æ–‡æ ‡é¢˜ã€‘ï¼Œç³»ç»Ÿéœ€è¦ç”¨æ ‡é¢˜æ¥åˆ›å»ºå›¾ç‰‡æ–‡ä»¶å¤¹ï¼");
                titleInput.focus();
                return;
            }
            document.getElementById('img-upload').click();
        };

        const imgInput = document.getElementById("img-upload");
        imgInput.addEventListener("change", async () => {
            const file = imgInput.files[0];
            if (!file) return;

            const title = titleInput.value.trim();
            const folderName = generateTargetName(title);

            const token = prompt(`ğŸ“‚ å›¾ç‰‡å°†å­˜å…¥ images/${folderName}\nè¯·è¾“å…¥ Token:`);
            if (!token) { imgInput.value = ""; return; }

            statusText.innerText = "ä¸Šä¼ å›¾ç‰‡ä¸­...";
            try {
                const imageUrl = await uploadImage(file, folderName, token);
                const mdImage = `\n![${file.name}](${imageUrl})\n`;
                window.insertMD(mdImage, "");
                alert("âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ");
                statusText.innerText = "å›¾ç‰‡å·²æ’å…¥";
            } catch (e) {
                alert("âŒ å¤±è´¥: " + e.message);
                statusText.innerText = "ä¸Šä¼ å¤±è´¥";
            } finally {
                imgInput.value = "";
            }
        });

        // --- ä¿å­˜é€»è¾‘ ---
        saveBtn.onclick = async () => {
            const title = titleInput.value.trim();
            const body = contentArea.value;

            if (!title) return alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼");

            const finalContent = `# ${title}\n\n${body}`;
            const token = prompt("ğŸ” è¯·è¾“å…¥ Token ä»¥ä¿å­˜:");
            if (!token) return;

            statusText.innerText = "æ­£åœ¨ä¿å­˜...";
            saveBtn.disabled = true;

            try {
                const targetFilename = generateTargetName(title) + ".md";
                await savePost(targetFilename, finalContent, token);
                alert(`âœ… ä¿å­˜æˆåŠŸï¼`);
                window.location.href = "index.html";
            } catch (e) {
                alert("âŒ ä¿å­˜å¤±è´¥: " + e.message);
                saveBtn.disabled = false;
                statusText.innerText = "ä¿å­˜å¤±è´¥";
            }
        };

        // --- å·¥å…·æ å‡½æ•° ---
        window.insertMD = (prefix, suffix) => {
            const start = contentArea.selectionStart;
            const end = contentArea.selectionEnd;
            const text = contentArea.value;
            contentArea.value = text.substring(0, start) + prefix + text.substring(start, end) + suffix + text.substring(end);
            contentArea.focus();
            contentArea.selectionStart = start + prefix.length;
            contentArea.selectionEnd = end + prefix.length;
        };
        window.insertTable = () => window.insertMD('\n| è¡¨å¤´1 | è¡¨å¤´2 |\n| --- | --- |\n| å†…å®¹1 | å†…å®¹2 |\n', '');
        
        // --- æ–‡ä»¶é€‰æ‹©å™¨é€»è¾‘ ---
        let currentPath = "";
        document.getElementById("openFileBtn").onclick = () => {
            document.getElementById("modal-overlay").style.display = "block";
            loadFiles("");
        };
        window.closeModal = () => { document.getElementById("modal-overlay").style.display = "none"; };
        
        async function loadFiles(path) {
            currentPath = path;
            document.getElementById("current-path").innerText = "è·¯å¾„: " + (path || "æ ¹ç›®å½•");
            const listEl = document.getElementById("file-list");
            listEl.innerHTML = "<li>âŒ› åŠ è½½ä¸­...</li>";
            const items = await listDir(path);
            listEl.innerHTML = "";
            if (path !== "") {
                const li = document.createElement("li");
                li.innerHTML = `<span class="icon">ğŸ”™</span> .. (è¿”å›ä¸Šçº§)`;
                li.onclick = () => {
                    const parts = currentPath.split('/');
                    parts.pop();
                    loadFiles(parts.join('/'));
                };
                listEl.appendChild(li);
            }
            items.sort((a, b) => (a.type === b.type ? 0 : a.type === "dir" ? -1 : 1));
            items.forEach(item => {
                const li = document.createElement("li");
                if (item.type === "dir") {
                    li.innerHTML = `<span class="icon">ğŸ“‚</span> ${item.name}`;
                    li.onclick = () => loadFiles(item.path);
                } else {
                    li.innerHTML = `<span class="icon">ğŸ“„</span> ${item.name}`;
                    li.onclick = () => {
                        window.insertMD(`\n<div class="file-card"><span class="file-name">ğŸ“„ ${item.name}</span><span class="file-download" data-path="${item.path}">â¬‡ï¸ ä¸‹è½½</span></div>\n`, "");
                        closeModal();
                    };
                }
                listEl.appendChild(li);
            });
        }
    </script>
</body>
</html>
