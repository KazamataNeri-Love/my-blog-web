<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å†™æ–‡ç«  - å¸¦æ–‡ä»¶æ’å…¥</title>
    <style>
        body { max-width: 800px; margin: 20px auto; padding: 20px; font-family: sans-serif; }
        input, textarea { width: 100%; box-sizing: border-box; margin-bottom: 15px; padding: 10px; }
        textarea { height: 400px; font-family: monospace; line-height: 1.5; }
        .toolbar { margin-bottom: 10px; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-green { background: #2da44e; color: white; }
        .btn-gray { background: #f6f8fa; border: 1px solid #d0d7de; }

        /* --- å¼¹çª—æ ·å¼ --- */
        #modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        #modal { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        #file-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; }
        #file-list li { padding: 8px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center;}
        #file-list li:hover { background: #f6f8fa; }
        .icon { margin-right: 8px; }
        .folder { color: #dcb67a; } /* é‡‘è‰²æ–‡ä»¶å¤¹ */
        .file { color: #57606a; }
    </style>
</head>
<body>
    <a href="index.html">â† è¿”å›åˆ—è¡¨</a>
    <h2>æ–°å»º / ç¼–è¾‘æ–‡ç« </h2>
    
    <input type="text" id="filename" placeholder="æ–‡ä»¶å (ä¾‹å¦‚: 2023-summary.md)">
    
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <button class="btn-gray" id="insertBtn">ğŸ“ æ’å…¥ GitHub ä»“åº“æ–‡ä»¶</button>
    </div>

    <textarea id="content" placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹..."></textarea>
    
    <button id="save" class="btn-green">ä¿å­˜åˆ° GitHub</button>

    <!-- æ–‡ä»¶é€‰æ‹©å¼¹çª— -->
    <div id="modal-overlay">
        <div id="modal">
            <h3>é€‰æ‹©æ–‡ä»¶</h3>
            <div id="current-path" style="font-size: 12px; color:#666; margin-bottom:5px;">è·¯å¾„: /</div>
            <ul id="file-list">åŠ è½½ä¸­...</ul>
            <button class="btn-gray" onclick="closeModal()" style="margin-top:10px; width:100%">å…³é—­</button>
        </div>
    </div>

    <script type="module">
        import { savePost, listDir } from "./js/api.js";

        // --- æ ¸å¿ƒé€»è¾‘ ---
        const contentArea = document.getElementById("content");
        let currentPath = ""; // å½“å‰æµè§ˆçš„ç›®å½•

        // 1. æ‰“å¼€å¼¹çª—
        document.getElementById("insertBtn").onclick = () => {
            document.getElementById("modal-overlay").style.display = "block";
            loadFiles(""); // åˆå§‹åŠ è½½æ ¹ç›®å½•
        };

        // 2. å…³é—­å¼¹çª—
        window.closeModal = () => {
            document.getElementById("modal-overlay").style.display = "none";
        };

        // 3. åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFiles(path) {
            currentPath = path;
            document.getElementById("current-path").innerText = "è·¯å¾„: " + (path || "/");
            const listEl = document.getElementById("file-list");
            listEl.innerHTML = "<li>âŒ› åŠ è½½ä¸­...</li>";

            const items = await listDir(path);
            listEl.innerHTML = ""; // æ¸…ç©º

            // å¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼ŒåŠ ä¸€ä¸ªâ€œè¿”å›ä¸Šä¸€çº§â€
            if (path !== "") {
                const li = document.createElement("li");
                li.innerHTML = `<span class="icon">ğŸ”™</span> .. (è¿”å›ä¸Šä¸€çº§)`;
                li.onclick = () => {
                    // é€»è¾‘ï¼šå»æ‰æœ€åä¸€å±‚è·¯å¾„
                    const parts = currentPath.split('/');
                    parts.pop();
                    loadFiles(parts.join('/'));
                };
                listEl.appendChild(li);
            }

            // æ’åºï¼šæ–‡ä»¶å¤¹åœ¨å‰ï¼Œæ–‡ä»¶åœ¨å
            items.sort((a, b) => (a.type === b.type ? 0 : a.type === "dir" ? -1 : 1));

            items.forEach(item => {
                const li = document.createElement("li");
                if (item.type === "dir") {
                    li.innerHTML = `<span class="icon folder">ğŸ“‚</span> ${item.name}`;
                    li.onclick = () => loadFiles(item.path); // ç‚¹å‡»è¿›å…¥æ–‡ä»¶å¤¹
                } else {
                    li.innerHTML = `<span class="icon file">ğŸ“„</span> ${item.name}`;
                    li.onclick = () => insertFileCode(item.name, item.path); // ç‚¹å‡»æ’å…¥æ–‡ä»¶
                }
                listEl.appendChild(li);
            });
        }

        // 4. æ’å…¥ä»£ç åˆ°ç¼–è¾‘å™¨
        function insertFileCode(name, path) {
            // ç”Ÿæˆä¸€æ®µ HTML ä»£ç 
            const htmlSnippet = `
<div class="file-card">
  <span class="file-name">ğŸ“„ ${name}</span>
  <span class="file-download" data-path="${path}">â¬‡ï¸ ä¸‹è½½</span>
</div>
`;
            // æ’å…¥åˆ°å…‰æ ‡ä½ç½®
            const start = contentArea.selectionStart;
            const end = contentArea.selectionEnd;
            const text = contentArea.value;
            contentArea.value = text.substring(0, start) + htmlSnippet + text.substring(end);
            
            closeModal();
        }

        // --- ä¿å­˜é€»è¾‘ (ä¿æŒä¸å˜) ---
        document.getElementById("save").onclick = async () => {
            const name = document.getElementById("filename").value;
            const text = document.getElementById("content").value;
            
            if (!name || !text) return alert("è¯·å¡«å†™å®Œæ•´ï¼");
            if (!name.endsWith(".md")) return alert("æ–‡ä»¶åå¿…é¡»ä»¥ .md ç»“å°¾");

            const token = prompt("ğŸ” è¯·è¾“å…¥ä½ çš„ GitHub Token ä»¥éªŒè¯èº«ä»½ï¼š");
            if (!token) return;

            try {
                document.getElementById("save").innerText = "æ­£åœ¨ä¿å­˜...";
                await savePost(name, text, token);
                alert("âœ… å‘å¸ƒæˆåŠŸï¼");
                window.location.href = "index.html";
            } catch (e) {
                alert(e.message);
                document.getElementById("save").innerText = "ä¿å­˜åˆ° GitHub";
            }
        };
    </script>
</body>
</html>
