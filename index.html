<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ GitHub åšå®¢</title>
    <style>
        /* --- CSS æ ·å¼ --- */
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; overflow: hidden; }
        
        /* å·¦ä¾§ä¾§è¾¹æ  */
        #sidebar { 
            width: 260px; 
            background: #f7f7f7; 
            border-right: 1px solid #ddd; 
            display: flex; flex-direction: column; 
            padding: 10px;
        }
        #sidebar h3 { margin: 10px 0; font-size: 16px; color: #333; }
        
        /* ç›®å½•æ ‘æ ·å¼ */
        .tree-container { flex: 1; overflow-y: auto; }
        ul { list-style: none; padding-left: 15px; margin: 0; }
        li { margin: 2px 0; }
        
        .node-row { 
            display: flex; align-items: center; 
            padding: 4px 8px; cursor: pointer; border-radius: 4px; 
            font-size: 14px; color: #444; user-select: none;
        }
        .node-row:hover { background: #e0e0e0; }
        .node-row.active { background: #d0e8ff; color: #0066cc; }
        .icon { margin-right: 6px; width: 16px; text-align: center; }
        
        /* æ—‹è½¬ç®­å¤´ */
        .arrow { font-size: 10px; margin-right: 5px; transition: transform 0.2s; display: inline-block; color: #999;}
        .arrow.open { transform: rotate(90deg); }
        .arrow.hidden { visibility: hidden; }

        /* å³ä¾§å†…å®¹åŒº */
        #main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        #content { max-width: 800px; margin: 0 auto; line-height: 1.6; }
        
        /* é¡¶éƒ¨ç”¨æˆ·æ  */
        #user-bar { position: absolute; top: 10px; right: 20px; display: flex; gap: 10px; align-items: center; }
        .avatar-btn { width: 36px; height: 36px; background: #ddd; border-radius: 50%; cursor: pointer; text-align: center; line-height: 36px; font-size: 20px; }
        .avatar-btn.logged-in { background: #4caf50; color: white; }

        /* å·¥å…·æŒ‰é’® */
        .btn { padding: 5px 12px; cursor: pointer; background: white; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .hidden { display: none; }

        /* æ¨¡æ€æ¡† */
        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal { background: white; padding: 20px; border-radius: 8px; width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <!-- å·¦ä¾§ç›®å½• -->
    <div id="sidebar">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>ğŸ“š æ–‡ç« ç›®å½•</h3>
            <button id="btn-create" class="btn btn-primary hidden" onclick="showCreateModal()">+</button>
        </div>
        <div class="tree-container" id="tree-root">
            <div style="padding:10px; color:#666;">æ­£åœ¨åŠ è½½ GitHub æ•°æ®...</div>
        </div>
    </div>

    <!-- å³ä¾§ä¸»å†…å®¹ -->
    <div id="main">
        <!-- é¡¶éƒ¨è´¦å·æ  -->
        <div id="user-bar">
            <button id="btn-edit" class="btn hidden">âœ ç¼–è¾‘æ­¤æ–‡</button>
            <div id="avatar" class="avatar-btn" title="ç‚¹å‡»è¾“å…¥ Token">ğŸ‘¤</div>
        </div>

        <div id="content">
            <h1>æ¬¢è¿</h1>
            <p>è¯·ç‚¹å‡»å·¦ä¾§ç›®å½•æŸ¥çœ‹æ–‡ç« ã€‚</p>
        </div>
    </div>

    <!-- æ–°å»ºæ–‡ä»¶æ¨¡æ€æ¡† -->
    <div id="modal-overlay">
        <div class="modal">
            <h3>æ–°å»ºæ–‡ä»¶/æ–‡ä»¶å¤¹</h3>
            <p style="font-size:12px; color:#666;">è·¯å¾„ç¤ºä¾‹: å­¦ä¹ /ç¬”è®°.md (åˆ›å»ºæ–‡ä»¶å¤¹å’Œæ–‡ä»¶)</p>
            <input type="text" id="new-path" placeholder="æ–‡ä»¶å¤¹/æ–‡ä»¶å.md" style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;">
            <div style="text-align: right;">
                <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmCreate()">åˆ›å»º</button>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // âš ï¸ è¯·åœ¨è¿™é‡Œé…ç½®ä½ çš„ GitHub ä¿¡æ¯
    // ==========================================
    const CONFIG = {
        owner: 'KazamataNeri-Love',    // ä¾‹å¦‚ 'zhangsan'
        repo: 'my-blog-web',          // ä¾‹å¦‚ 'my-blog'
        branch: 'main',             // åˆ†æ”¯åï¼Œé€šå¸¸æ˜¯ main æˆ– master
        postsRoot: 'posts'          // æ–‡ç« å­˜æ”¾çš„æ ¹ç›®å½•å
    };
    // ==========================================

    let allFiles = []; // å­˜å‚¨ä» GitHub è·å–çš„åŸå§‹æ–‡ä»¶åˆ—è¡¨

    // --- 1. Token ç®¡ç† ---
    const Token = {
        get: () => localStorage.getItem('gh_token'),
        set: (t) => { localStorage.setItem('gh_token', t); location.reload(); },
        clear: () => { localStorage.removeItem('gh_token'); location.reload(); },
        has: () => !!localStorage.getItem('gh_token')
    };

    // --- 2. GitHub API å°è£… ---
    async function ghFetch(url, options = {}) {
        const headers = options.headers || {};
        const token = Token.get();
        if (token) headers['Authorization'] = `token ${token}`;
        
        const res = await fetch(url, { ...options, headers });
        if (res.status === 401 || res.status === 403) {
            // å¦‚æœåªæœ‰è¯»å–æƒé™ä¸å¤Ÿï¼ˆæ¯”å¦‚ç§æœ‰ä»“åº“ï¼‰æˆ–è€…è¶…é™ï¼Œè¿™é‡Œä¼šæŠ¥é”™
            console.warn("API æƒé™é—®é¢˜æˆ–é™æµ");
        }
        return res;
    }

    // --- 3. æ ¸å¿ƒï¼šè·å–ç›®å½•æ ‘ ---
    async function init() {
        updateAuthUI();
        
        // ä½¿ç”¨ GitHub Git Data API è·å–å®Œæ•´æ ‘ç»“æ„ (recursive=1)
        const apiUrl = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/git/trees/${CONFIG.branch}?recursive=1`;
        
        try {
            const res = await ghFetch(apiUrl);
            if (!res.ok) throw new Error("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·å/ä»“åº“åæˆ– Token");
            const data = await res.json();
            
            // ç­›é€‰å‡º posts/ ä¸‹çš„æ–‡ä»¶ï¼Œæ’é™¤ posts/ æœ¬èº«
            allFiles = data.tree.filter(item => 
                item.path.startsWith(CONFIG.postsRoot + '/') && item.type === 'blob' // blob ä»£è¡¨æ–‡ä»¶
            );

            // æ¸²æŸ“ä¾§è¾¹æ 
            renderSidebar(allFiles);

        } catch (e) {
            document.getElementById('tree-root').innerHTML = `<p style="color:red; padding:10px;">é”™è¯¯ï¼š${e.message}</p>`;
        }
    }

    // --- 4. è·¯å¾„è½¬æ ‘å½¢ç»“æ„ç®—æ³• ---
    function buildTreeFromPaths(fileList) {
        const root = { name: "root", children: {} };

        fileList.forEach(file => {
            // å»æ‰å¼€å¤´çš„ "posts/"
            const relativePath = file.path.substring(CONFIG.postsRoot.length + 1);
            const parts = relativePath.split('/'); // ["æŠ€æœ¯", "å‰ç«¯", "a.md"]
            
            let current = root;
            parts.forEach((part, index) => {
                if (!current.children[part]) {
                    current.children[part] = {
                        name: part,
                        // å¦‚æœæ˜¯è·¯å¾„æœ€åä¸€æ®µï¼Œåˆ™æ˜¯æ–‡ä»¶
                        type: index === parts.length - 1 ? 'file' : 'folder',
                        path: file.path, // å®Œæ•´è·¯å¾„
                        sha: file.sha,
                        children: {}
                    };
                }
                current = current.children[part];
            });
        });
        return root.children;
    }

    // --- 5. æ¸²æŸ“é€»è¾‘ (é€’å½’) ---
    function renderSidebar(fileList) {
        const treeRoot = document.getElementById('tree-root');
        treeRoot.innerHTML = '';
        
        const treeData = buildTreeFromPaths(fileList);
        const ul = createTreeDom(treeData);
        treeRoot.appendChild(ul);
    }

    function createTreeDom(nodes) {
        const ul = document.createElement('ul');
        
        // å¯¹èŠ‚ç‚¹æ’åºï¼šæ–‡ä»¶å¤¹åœ¨å‰ï¼Œæ–‡ä»¶åœ¨å
        const sortedKeys = Object.keys(nodes).sort((a, b) => {
            const nodeA = nodes[a];
            const nodeB = nodes[b];
            if (nodeA.type === nodeB.type) return a.localeCompare(b);
            return nodeA.type === 'folder' ? -1 : 1;
        });

        sortedKeys.forEach(key => {
            const node = nodes[key];
            const li = document.createElement('li');

            // 1. èŠ‚ç‚¹è¡Œ UI
            const row = document.createElement('div');
            row.className = 'node-row';
            
            // å›¾æ ‡ä¸ç®­å¤´
            const arrow = document.createElement('span');
            arrow.className = `arrow ${node.type === 'folder' ? '' : 'hidden'}`;
            arrow.innerText = 'â–¶';
            
            const icon = document.createElement('span');
            icon.className = 'icon';
            icon.innerText = node.type === 'folder' ? 'ğŸ“' : 'ğŸ“„';

            const text = document.createElement('span');
            text.innerText = node.name.replace('.md', ''); // éšè— .md åç¼€

            row.append(arrow, icon, text);
            li.appendChild(row);

            // 2. äº¤äº’é€»è¾‘
            if (node.type === 'folder') {
                const childUl = createTreeDom(node.children);
                childUl.style.display = 'none'; // é»˜è®¤æŠ˜å 
                li.appendChild(childUl);

                row.onclick = (e) => {
                    e.stopPropagation();
                    const isClosed = childUl.style.display === 'none';
                    childUl.style.display = isClosed ? 'block' : 'none';
                    arrow.classList.toggle('open', isClosed);
                    icon.innerText = isClosed ? 'ğŸ“‚' : 'ğŸ“';
                };
            } else {
                // æ˜¯æ–‡ä»¶ï¼Œç‚¹å‡»åŠ è½½
                row.onclick = () => loadPost(node.path, row);
            }

            ul.appendChild(li);
        });
        return ul;
    }

    // --- 6. åŠ è½½æ–‡ç« å†…å®¹ ---
    async function loadPost(path, domElement) {
        // é«˜äº®å½“å‰é€‰ä¸­çš„èœå•
        document.querySelectorAll('.node-row').forEach(el => el.classList.remove('active'));
        if(domElement) domElement.classList.add('active');

        document.getElementById('content').innerHTML = 'åŠ è½½ä¸­...';
        
        // è¿™é‡Œçš„ path æ˜¯ "posts/xxx/xxx.md"
        const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}?ref=${CONFIG.branch}`;
        
        try {
            const res = await ghFetch(url);
            const data = await res.json();
            
            // GitHub API è¿”å›çš„å†…å®¹æ˜¯ Base64 ç¼–ç çš„
            // ä½¿ç”¨ decodeURIComponent(escape(window.atob(str))) è§£å†³ä¸­æ–‡ä¹±ç 
            const content = decodeURIComponent(escape(window.atob(data.content)));

            // ç®€å•çš„ Markdown è½¬ HTML (ä½ å¯èƒ½éœ€è¦å¼•å…¥ marked.js åº“æ¥åšå¾—æ›´å¥½)
            // è¿™é‡Œåªåšç®€å•æ¼”ç¤ºï¼š
            document.getElementById('content').innerHTML = `
                <h1 style="border-bottom:1px solid #eee; padding-bottom:10px;">${data.name.replace('.md','')}</h1>
                <div style="white-space: pre-wrap;">${content}</div>
            `;
            
            // æ›´æ–°ç¼–è¾‘æŒ‰é’®é“¾æ¥
            const btnEdit = document.getElementById('btn-edit');
            btnEdit.onclick = () => window.open(`editor.html?path=${encodeURIComponent(path)}`, '_blank');

        } catch (e) {
            document.getElementById('content').innerText = "åŠ è½½å¤±è´¥: " + e.message;
        }
    }

    // --- 7. UI ä¸ è´¦å·é€»è¾‘ ---
    function updateAuthUI() {
        const avatar = document.getElementById('avatar');
        const btnCreate = document.getElementById('btn-create');
        const btnEdit = document.getElementById('btn-edit');

        if (Token.has()) {
            avatar.innerText = 'ğŸ‘‘';
            avatar.classList.add('logged-in');
            avatar.title = "å·²ç™»å½• (ç‚¹å‡»ç™»å‡º)";
            btnCreate.classList.remove('hidden');
            btnEdit.classList.remove('hidden');
        } else {
            avatar.innerText = 'ğŸ‘¤';
            avatar.classList.remove('logged-in');
            avatar.title = "ç‚¹å‡»è¾“å…¥ Token ç™»å½•";
            btnCreate.classList.add('hidden');
            btnEdit.classList.add('hidden');
        }
    }

    document.getElementById('avatar').onclick = () => {
        if (Token.has()) {
            if (confirm("è¦æ¸…é™¤ Token é€€å‡ºç™»å½•å—ï¼Ÿ")) Token.clear();
        } else {
            const t = prompt("è¯·è¾“å…¥ GitHub Personal Access Token (æƒé™: repo):");
            if (t) Token.set(t);
        }
    };

    // --- 8. åˆ›å»ºåŠŸèƒ½ (å¤šçº§ç›®å½•å®ç°æ ¸å¿ƒ) ---
    window.showCreateModal = () => document.getElementById('modal-overlay').style.display = 'flex';
    window.closeModal = () => document.getElementById('modal-overlay').style.display = 'none';

    window.confirmCreate = async () => {
        const input = document.getElementById('new-path').value; // ä¾‹å¦‚: "ç¬”è®°/JavaScript/æ–°æ–‡ç« .md"
        if (!input) return;

        // æ‹¼æ¥å®Œæ•´è·¯å¾„
        const fullPath = `${CONFIG.postsRoot}/${input}`;
        const content = "# æ–°æ–‡ç« \n\nè¯·å¼€å§‹ç¼–å†™...";
        const message = `Create ${input} via Web`;

        // GitHub API åˆ›å»ºæ–‡ä»¶ (PUT)
        const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${fullPath}`;
        
        try {
            const res = await ghFetch(url, {
                method: 'PUT',
                body: JSON.stringify({
                    message: message,
                    content: btoa(unescape(encodeURIComponent(content))), // Base64 ç¼–ç 
                    branch: CONFIG.branch
                })
            });

            if (res.ok) {
                alert("åˆ›å»ºæˆåŠŸï¼");
                closeModal();
                // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ–‡ä»¶
                location.reload();
                // ä¹Ÿå¯ä»¥ç›´æ¥è·³è½¬åˆ°ç¼–è¾‘é¡µ
                // window.open(`editor.html?path=${encodeURIComponent(fullPath)}`, '_blank');
            } else {
                const err = await res.json();
                alert("åˆ›å»ºå¤±è´¥: " + err.message);
            }
        } catch (e) {
            alert("ç½‘ç»œé”™è¯¯: " + e.message);
        }
    };

    // å¯åŠ¨
    init();
</script>
</body>
</html>
