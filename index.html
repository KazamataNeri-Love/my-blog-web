<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„çŸ¥è¯†åº“</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-sidebar: #1e1e1e;
            --bg-main: #191919;
            --text-main: #e0e0e0;
            --text-sub: #858585;
            --accent-color: #3794ff;
            --hover-bg: #2d2d2d;
            --border-color: #333333;
            --blockquote-border: #3794ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, "JetBrains Mono", "Microsoft YaHei", monospace;
            background-color: var(--bg-main);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            letter-spacing: -0.5px;
        }

        input, button, select, textarea { font-family: inherit; }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar {
            width: 300px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .search-container { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .search-box {
            background: #2d2d2d; border: 1px solid #3e3e3e; border-radius: 4px;
            display: flex; align-items: center; padding: 6px 10px;
        }
        .search-box i { color: var(--text-sub); font-size: 14px; }
        .search-box input {
            background: transparent; border: none; color: var(--text-main);
            margin-left: 8px; width: 100%; outline: none; font-size: 13px;
        }

        .nav-list { flex: 1; overflow-y: auto; padding: 10px 0; list-style: none; }
        
        .nav-item {
            padding: 8px 20px 8px 30px; cursor: pointer; display: flex;
            align-items: center; text-decoration: none; color: var(--text-sub);
            font-size: 13px; transition: all 0.2s; border-right: 3px solid transparent;
        }
        .nav-item:hover { background-color: var(--hover-bg); color: var(--text-main); }
        .nav-item.active {
            color: var(--accent-color); background-color: #262f3e;
            border-right: 3px solid var(--accent-color);
        }
        .nav-item i { margin-right: 10px; font-size: 14px; width: 16px; text-align: center; }

        /* --- å¤šçº§ç›®å½•ä¸æ’åºæ æ ·å¼ --- */
        .nested-ul { display: none; padding-left: 0; list-style: none; background: rgba(0,0,0,0.1); }
        .folder-open > .nested-ul { display: block; }
        .folder-icon { transition: transform 0.2s; }
        .folder-open > .nav-item > .folder-icon { transform: rotate(90deg); color: var(--accent-color); }
        
        /* ç¼©è¿› */
        .nav-item.level-1 { padding-left: 30px; }
        .nav-item.level-2 { padding-left: 45px; }
        .nav-item.level-3 { padding-left: 60px; }
        .nav-item.level-4 { padding-left: 75px; }

        /* æ’åº/åˆ†ç»„æ ‡é¢˜æ  */
        .nav-group-title {
            padding: 15px 20px 5px; 
            font-size: 12px; 
            color: var(--text-sub);
            font-weight: bold; 
            text-transform: uppercase; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            position: relative;
        }
        
        .sort-btn {
            cursor: pointer; padding: 4px 6px; border-radius: 4px; color: var(--text-sub); transition: 0.2s;
        }
        .sort-btn:hover { background-color: #383838; color: var(--text-main); }
        
        .sort-popup {
            position: absolute; right: 10px; top: 35px;
            background-color: #2d2d2d; border: 1px solid #444; border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 1000;
            min-width: 140px; display: none; overflow: hidden;
        }
        .sort-popup.show { display: block; }

        .sort-option {
            padding: 8px 12px; font-size: 12px; color: #ccc; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
        }
        .sort-option:hover { background-color: #383838; color: #fff; }
        .sort-option.active { color: var(--accent-color); font-weight: bold; }
        .sort-option .check-icon { opacity: 0; font-size: 12px; }
        .sort-option.active .check-icon { opacity: 1; }
        /* ----------------------- */

        .sidebar-footer {
            padding: 15px; border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-between; color: var(--text-sub); font-size: 12px;
        }

        /* --- ä¸»å†…å®¹åŒº --- */
        .main-content {
            flex: 1; overflow-y: auto; padding: 40px 60px;
            background-image: linear-gradient(to bottom, #1e1e1e 0%, var(--bg-main) 300px);
            position: relative;
        }

        .doc-header { margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .doc-title { font-size: 28px; font-weight: bold; color: #fff; line-height: 1.3; margin-right: 20px;}
        .actions { display: flex; gap: 10px; }
        .btn {
            background-color: var(--hover-bg); color: var(--text-main); border: 1px solid var(--border-color);
            padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;
            text-decoration: none; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .btn:hover { background-color: #333; border-color: #555; }

        .doc-meta { display: flex; gap: 20px; color: var(--text-sub); font-size: 12px; align-items: center; }
        
        .markdown-body { line-height: 1.7; color: #d4d4d4; max-width: 900px; font-size: 14px; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: #fff; margin-top: 24px; margin-bottom: 16px; font-weight: 600; }
        .markdown-body h1 { font-size: 2em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        .markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        .markdown-body a { color: var(--accent-color); text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body blockquote { padding: 10px 15px; color: #999; border-left: 0.25em solid var(--blockquote-border); margin: 0 0 16px 0; background: #222; border-radius: 0 4px 4px 0; }
        .markdown-body code { padding: 0.2em 0.4em; font-size: 85%; background-color: rgba(110,118,129,0.4); border-radius: 6px; font-family: inherit; }
        .markdown-body pre { padding: 16px; overflow: auto; background-color: #161b22; border-radius: 6px; border: 1px solid #30363d; }
        .markdown-body pre code { background-color: transparent; padding: 0; }
        .markdown-body table { border-spacing: 0; border-collapse: collapse; width: 100%; margin-bottom: 16px; display: block; overflow: auto;}
        .markdown-body table th, .markdown-body table td { padding: 6px 13px; border: 1px solid #30363d; }
        .markdown-body table th { background-color: #161b22; }
        .markdown-body img { max-width: 100%; border-radius: 4px; background-color: #fff; }

        /* æ–‡ä»¶å¡ç‰‡æ ·å¼ */
        .file-card { background: #21262d; border: 1px solid #30363d; border-radius: 6px; padding: 12px 16px; margin: 15px 0; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .file-name { font-weight: 600; color: var(--accent-color); display: flex; align-items: center; gap: 8px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
        .file-info { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .file-note { font-size: 12px; color: #8b949e; background: #30363d; padding: 2px 6px; border-radius: 4px; white-space: nowrap; }
        .file-download { color: var(--text-main); font-size: 13px; padding: 4px 10px; background: #30363d; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; white-space: nowrap; }
        .file-download:hover { background: var(--accent-color); color: white; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-sidebar); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        @media (max-width: 768px) {
            .sidebar { display: none; position: absolute; height: 100%; z-index: 100; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
            .sidebar.open { display: flex; }
            .main-content { padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar" id="sidebar">
        <div class="search-container">
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="search-input" placeholder="æœç´¢æ–‡ç« ...">
            </div>
        </div>

        <ul class="nav-list" id="sidebar-list">
            <li style="text-align:center; color:#666; padding:20px;">
                <i class="fa-solid fa-spinner fa-spin"></i> åŠ è½½ä¸­...
            </li>
        </ul>

        <div class="sidebar-footer">
            <span><i class="fa-solid fa-database"></i> GitHub Tree</span>
            <span id="version-tag">v3.0 Tree</span>
        </div>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
        <div class="doc-header" id="header-area" style="display:none;">
            <div class="header-top">
                <h1 class="doc-title" id="article-title">æ— æ ‡é¢˜</h1>
                <div class="actions">
                    <a id="btn-edit" href="#" class="btn" target="_blank"><i class="fa-solid fa-pen"></i> ç¼–è¾‘</a>
                </div>
            </div>
            
            <div class="doc-meta">
                <span id="article-date"><i class="fa-regular fa-calendar"></i> -</span>
                <span><i class="fa-regular fa-user"></i> Admin</span>
                <span id="article-file" style="opacity:0.6; font-size:10px;">filename.md</span>
            </div>
        </div>

        <div id="empty-state" class="markdown-body" style="margin-top: 50px; text-align: center; color: var(--text-sub);">
            <div style="font-size: 60px; margin-bottom: 20px; opacity: 0.2;">
                <i class="fa-regular fa-compass"></i>
            </div>
            <h2>> æ¬¢è¿æ¥åˆ°çŸ¥è¯†åº“ <</h2>
            <p>ç‚¹å‡»å·¦ä¾§ç›®å½•æŸ¥çœ‹æ–‡ç« ï¼Œæˆ–è€…æœç´¢ã€‚</p>
        </div>

        <div id="article-body" class="markdown-body"></div>
    </main>

    <script type="module">
        import { fetchFileTree, getPost, downloadFile } from "./js/api.js";
        
        // DOM å…ƒç´ å¼•ç”¨
        const sidebarList = document.getElementById("sidebar-list");
        const searchInput = document.getElementById("search-input");
        const headerArea = document.getElementById("header-area");
        const emptyState = document.getElementById("empty-state");
        const articleBody = document.getElementById("article-body");
        
        const uiTitle = document.getElementById("article-title");
        const uiDate = document.getElementById("article-date");
        const uiFile = document.getElementById("article-file");
        const btnEdit = document.getElementById("btn-edit");

        let allFiles = []; 
        let currentSortMode = 'date'; // é»˜è®¤æŒ‰æ—¶é—´å€’åº

        // --- åˆå§‹åŒ– ---
        async function init() {
            await loadSidebar();
            
            const params = new URLSearchParams(location.search);
            const path = params.get("f");
            
            if (path) {
                loadContent(decodeURIComponent(path));
            } else {
                showHome();
            }
        }
        init();

        // --- åŠ è½½ä¾§è¾¹æ æ•°æ® (Tree) ---
        async function loadSidebar() {
            try {
                allFiles = await fetchFileTree();
                const tree = buildTree(allFiles);
                renderSidebarTree(tree);
            } catch (e) {
                console.error(e);
                sidebarList.innerHTML = `<li style="color:#ff6b6b; padding:15px">âš ï¸ åŠ è½½å¤±è´¥: ${e.message}</li>`;
            }
        }

        // --- æ ¸å¿ƒï¼šè·¯å¾„è½¬åµŒå¥—å¯¹è±¡ ---
        function buildTree(files) {
            const root = {};
            files.forEach(file => {
                if (file.type !== 'blob' && file.type !== 'tree') return; 
                if (!file.path.endsWith('.md') && file.type === 'blob') return; 

                const parts = file.path.replace(/^posts\//, '').split('/');
                let current = root;
                parts.forEach((part, index) => {
                    if (!current[part]) {
                        current[part] = {
                            name: part,
                            path: (index === parts.length - 1 && file.type === 'blob') ? file.path : null,
                            children: {}
                        };
                    }
                    current = current[part].children;
                });
            });
            return root;
        }

        // --- æ ¸å¿ƒï¼šé€’å½’æ¸²æŸ“æ ‘ (å¸¦åŠŸèƒ½åŒº) ---
        function renderSidebarTree(treeData) {
            sidebarList.innerHTML = "";

            // 1. å›ºå®šå¤´éƒ¨
            const newPostLi = document.createElement("li");
            newPostLi.innerHTML = `
                <a href="editor.html" target="_blank" class="nav-item" style="color: var(--text-sub);">
                    <i class="fa-solid fa-plus" style="color: #2da44e;"></i>
                    <span style="font-weight:bold; color: var(--text-main);">æ–°å»ºè´´æ–‡</span>
                </a>
            `;
            sidebarList.appendChild(newPostLi);

            const homeLi = document.createElement("li");
            homeLi.innerHTML = `
                <div class="nav-item" id="nav-home" onclick="showHome()">
                    <i class="fa-solid fa-house"></i>
                    <span>é¦–é¡µ / ç®€ä»‹</span>
                </div>
            `;
            sidebarList.appendChild(homeLi);

            // åˆ†éš”
            const separator = document.createElement("li");
            separator.style.borderBottom = "1px solid var(--border-color)";
            separator.style.margin = "8px 0";
            sidebarList.appendChild(separator);

            // 2. è´´æ–‡åˆ—è¡¨æ ‡é¢˜ + æ’åºæŒ‰é’®
            const groupTitle = document.createElement("li");
            groupTitle.className = "nav-group-title";
            groupTitle.innerHTML = `
                <span><i class="fa-regular fa-folder-open"></i> è´´æ–‡åˆ—è¡¨</span>
                
                <div class="sort-btn" onclick="event.stopPropagation(); toggleSortMenu()" title="æ’åºæ–¹å¼">
                    <i class="fa-solid fa-arrow-down-short-wide"></i>
                </div>

                <div id="sort-menu" class="sort-popup">
                    <div class="sort-option ${currentSortMode === 'date' ? 'active' : ''}" onclick="applySort('date')">
                        <span>ğŸ“… æŒ‰æ—¶é—´</span> <i class="fa-solid fa-check check-icon"></i>
                    </div>
                    <div class="sort-option ${currentSortMode === 'title' ? 'active' : ''}" onclick="applySort('title')">
                        <span>Aa æŒ‰æ ‡é¢˜</span> <i class="fa-solid fa-check check-icon"></i>
                    </div>
                </div>
            `;
            sidebarList.appendChild(groupTitle);

            // 3. é€’å½’ç›®å½•
            const container = document.createDocumentFragment();
            createTreeNodes(treeData, container, 1);
            sidebarList.appendChild(container);

            updateActiveState();
        }

        function createTreeNodes(nodes, parentEl, level) {
            // æ’åºé€»è¾‘
            const keys = Object.keys(nodes).sort((a, b) => {
                const nodeA = nodes[a];
                const nodeB = nodes[b];
                const isFolderA = Object.keys(nodeA.children).length > 0 && !nodeA.path;
                const isFolderB = Object.keys(nodeB.children).length > 0 && !nodeB.path;
                
                // æ–‡ä»¶å¤¹å§‹ç»ˆç½®é¡¶
                if (isFolderA && !isFolderB) return -1;
                if (!isFolderA && isFolderB) return 1;

                if (currentSortMode === 'date') {
                    // æŒ‰æ—¥æœŸå€’åº (å‡è®¾æ–‡ä»¶åå«æ—¥æœŸ)
                    return b.localeCompare(a, 'zh-CN');
                } else {
                    // æŒ‰æ ‡é¢˜æ­£åº (å¿½ç•¥æ—¥æœŸå‰ç¼€)
                    const nameA = a.replace(/^\d{4}-\d{1,2}-\d{1,2}-/, "");
                    const nameB = b.replace(/^\d{4}-\d{1,2}-\d{1,2}-/, "");
                    return nameA.localeCompare(nameB, 'zh-CN');
                }
            });

            keys.forEach(key => {
                const node = nodes[key];
                const isFolder = Object.keys(node.children).length > 0 && !node.path;
                
                const li = document.createElement("li");
                let displayName = node.name.replace(".md", "").replace(/^\d{4}-\d{1,2}-\d{1,2}-/, "");
                
                if (isFolder) {
                    li.innerHTML = `
                        <div class="nav-item level-${level}" onclick="toggleFolder(this)">
                            <i class="fa-solid fa-caret-right folder-icon" style="width:10px; margin-right:5px;"></i>
                            <i class="fa-regular fa-folder" style="color:#dcb67a;"></i>
                            <span>${displayName}</span>
                        </div>
                    `;
                    const ul = document.createElement("ul");
                    ul.className = "nested-ul";
                    createTreeNodes(node.children, ul, level + 1);
                    li.appendChild(ul);
                } else {
                    li.innerHTML = `
                        <div class="nav-item file-item level-${level}" data-path="${node.path}" onclick="handlePostClick('${node.path}')">
                            <i class="fa-regular fa-file-lines"></i>
                            <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${displayName}</span>
                        </div>
                    `;
                }
                parentEl.appendChild(li);
            });
        }

        // --- æ’åºä¸äº¤äº’ ---
        window.toggleSortMenu = () => {
            const menu = document.getElementById("sort-menu");
            if(menu) {
                menu.classList.toggle("show");
                if (menu.classList.contains("show")) {
                    setTimeout(() => document.addEventListener('click', closeSortMenuOutside), 0);
                }
            }
        };

        function closeSortMenuOutside(e) {
            const menu = document.getElementById("sort-menu");
            if (menu && !menu.contains(e.target)) {
                menu.classList.remove("show");
                document.removeEventListener('click', closeSortMenuOutside);
            }
        }

        window.applySort = (mode) => {
            currentSortMode = mode;
            const tree = buildTree(allFiles);
            renderSidebarTree(tree);
        };

        window.toggleFolder = (el) => {
            el.parentElement.classList.toggle("folder-open");
        };

        window.showHome = () => {
            const url = new URL(window.location);
            url.searchParams.delete('f');
            window.history.pushState({}, '', url);
            headerArea.style.display = "none";
            articleBody.innerHTML = "";
            emptyState.style.display = "block";
            updateActiveState();
        };

        window.handlePostClick = (path) => {
            loadContent(path);
        };

        // --- åŠ è½½å†…å®¹ ---
        async function loadContent(path) {
            headerArea.style.display = "none";
            emptyState.style.display = "none";
            articleBody.innerHTML = `<div style="text-align:center; padding:50px; color:#666"><i class="fa-solid fa-circle-notch fa-spin fa-2x"></i></div>`;
            
            const newUrl = `${window.location.pathname}?f=${encodeURIComponent(path)}`;
            window.history.pushState({ path: newUrl }, '', newUrl);
            updateActiveState();

            try {
                let text = await getPost(path);
                const lines = text.split('\n');
                const firstLine = lines[0].trim();
                let renderText = text;

                if (firstLine.startsWith('# ')) {
                    uiTitle.innerText = firstLine.replace(/^#\s+/, '').trim();
                    renderText = lines.slice(1).join('\n');
                } else {
                    const filename = path.split('/').pop();
                    uiTitle.innerText = filename.replace(".md", "").replace(/^\d{4}-\d{1,2}-\d{1,2}-/, "");
                }

                articleBody.innerHTML = marked.parse(renderText);
                uiFile.innerText = path;
                btnEdit.href = `editor.html?edit=${encodeURIComponent(path)}`;
                headerArea.style.display = "block";

                // ä¸‹è½½æŒ‰é’®å¤„ç†
                articleBody.querySelectorAll('.file-download').forEach(btn => {
                    btn.onclick = (e) => {
                        e.preventDefault();
                        downloadFile(btn.getAttribute('data-path'));
                    };
                });
                
                articleBody.querySelectorAll('img').forEach(img => {
                    img.onerror = () => { img.style.border = "1px solid #555"; img.alt += " (å›¾ç‰‡åŠ è½½å¤±è´¥)"; };
                });

            } catch (e) {
                console.error(e);
                articleBody.innerHTML = `<div style="color:#ff6b6b; padding:20px;">âŒ åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        function updateActiveState() {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const params = new URLSearchParams(location.search);
            const currentPath = params.get("f");

            if (!currentPath) {
                const homeBtn = document.getElementById("nav-home");
                if(homeBtn) homeBtn.classList.add("active");
            } else {
                const activeItem = document.querySelector(`.file-item[data-path="${decodeURIComponent(currentPath)}"]`);
                if(activeItem) {
                    activeItem.classList.add("active");
                    // è‡ªåŠ¨å±•å¼€
                    let parent = activeItem.parentElement.parentElement;
                    while (parent && parent.classList.contains('nested-ul')) {
                        parent.parentElement.classList.add('folder-open');
                        parent = parent.parentElement.parentElement;
                    }
                }
            }
        }

        // --- æœç´¢ ---
        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            if (!keyword) {
                const tree = buildTree(allFiles);
                renderSidebarTree(tree);
                return;
            }
            sidebarList.innerHTML = "";
            const matched = allFiles.filter(f => 
                f.type === 'blob' && f.path.endsWith('.md') && 
                f.path.toLowerCase().includes(keyword)
            );

            if (matched.length === 0) {
                sidebarList.innerHTML = "<li style='padding:15px; color:#666'>æ— æœç´¢ç»“æœ</li>";
                return;
            }

            matched.forEach(file => {
                const li = document.createElement("li");
                const displayName = file.path.replace("posts/", "").replace(".md", "");
                li.innerHTML = `
                    <div class="nav-item file-item" data-path="${file.path}" onclick="handlePostClick('${file.path}')">
                        <i class="fa-regular fa-file-lines"></i>
                        <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${displayName}</span>
                    </div>
                `;
                sidebarList.appendChild(li);
            });
        });

    </script>
</body>
</html>
